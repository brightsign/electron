From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tariq Bashir <tbashir@brightsign.biz>
Date: Thu, 22 Jun 2023 14:23:48 +0100
Subject: OS-14345: BrightSign Add a webpreference to disable pinch to zoom

In chromium pinch to zoom can be disabled globally using the command line switch
disable-pinch. BrightSign has a requirement to beable to disable pinch to zoom
at a browser window level. This patch adds enable_pinch_zoom as a webpreference
and sets its value in RenderWidgetHostViewEventHandler. The webpreference will
present on all platforms, but the change to set it is only present in aura (linux).
The webpreference will only be used if disable-pinch has not been set on the
command line.

diff --git a/content/browser/renderer_host/render_widget_host_view_aura.cc b/content/browser/renderer_host/render_widget_host_view_aura.cc
index 9840d0e1308bc6e4589f32f6eac5e27f353895dd..3eafab6894af54f25fcf92a829e8fd46eef6db98 100644
--- a/content/browser/renderer_host/render_widget_host_view_aura.cc
+++ b/content/browser/renderer_host/render_widget_host_view_aura.cc
@@ -300,6 +300,8 @@ RenderWidgetHostViewAura::RenderWidgetHostViewAura(
     double_tap_to_zoom_enabled_ =
         owner_delegate->GetWebkitPreferencesForWidget()
             .double_tap_to_zoom_enabled;
+
+    event_handler_->SetPinchZoomEnabled(owner_delegate->GetWebkitPreferencesForWidget().enable_pinch_zoom);
   }
 
   host()->render_frame_metadata_provider()->AddObserver(this);
diff --git a/content/browser/renderer_host/render_widget_host_view_event_handler.cc b/content/browser/renderer_host/render_widget_host_view_event_handler.cc
index 401e65a8ebe6fffc9b027da7e42d3afb76ab7bb2..d6cb3d003842402936629e1a6988fb2be685a69b 100644
--- a/content/browser/renderer_host/render_widget_host_view_event_handler.cc
+++ b/content/browser/renderer_host/render_widget_host_view_event_handler.cc
@@ -126,6 +126,16 @@ RenderWidgetHostViewEventHandler::~RenderWidgetHostViewEventHandler() {
   DCHECK(!mouse_locked_);
 }
 
+void RenderWidgetHostViewEventHandler::SetPinchZoomEnabled(bool pinch_zoom_enabled) {
+    // Pinch to zoom is controlled globally by a command line switch and (as a BrightSign
+    // feature) also by a webpreference. If the command line switch has been used, this will
+    // disable pinch to zoom and override the web preference. Otherwise we use the web
+    // preference value that is passed.
+    if (content::IsPinchToZoomEnabled()) {
+      pinch_zoom_enabled_ = pinch_zoom_enabled;
+    }
+}
+
 void RenderWidgetHostViewEventHandler::SetPopupChild(
     RenderWidgetHostViewBase* popup_child_host_view,
     ui::EventHandler* popup_child_event_handler) {
diff --git a/content/browser/renderer_host/render_widget_host_view_event_handler.h b/content/browser/renderer_host/render_widget_host_view_event_handler.h
index c8d05f899799a0aad0883ef6cf7f3d0652c53e67..a95a903f0c21f65b314e3152b0c6ab9be8f4c8c6 100644
--- a/content/browser/renderer_host/render_widget_host_view_event_handler.h
+++ b/content/browser/renderer_host/render_widget_host_view_event_handler.h
@@ -180,6 +180,8 @@ class CONTENT_EXPORT RenderWidgetHostViewEventHandler
         .set_max_time_between_phase_ended_and_momentum_phase_began(timeout);
   }
 
+  void SetPinchZoomEnabled(bool pinch_zoom_enabled);
+
  private:
   FRIEND_TEST_ALL_PREFIXES(InputMethodResultAuraTest,
                            FinishImeCompositionSession);
@@ -281,7 +283,7 @@ class CONTENT_EXPORT RenderWidgetHostViewEventHandler
 
   // Whether pinch-to-zoom should be enabled and pinch events forwarded to the
   // renderer.
-  const bool pinch_zoom_enabled_;
+  bool pinch_zoom_enabled_;
 
   // This flag when set ensures that we send over a notification to blink that
   // the current view has focus.
diff --git a/third_party/blink/public/common/web_preferences/web_preferences.h b/third_party/blink/public/common/web_preferences/web_preferences.h
index 0c08e298107d1aa0d0809691a98dd12b2c0aeb5a..7716f7333c12eab5910ac68dc02e829553da06c8 100644
--- a/third_party/blink/public/common/web_preferences/web_preferences.h
+++ b/third_party/blink/public/common/web_preferences/web_preferences.h
@@ -88,6 +88,7 @@ struct BLINK_COMMON_EXPORT WebPreferences {
   bool privileged_webgl_extensions_enabled;
   bool webgl_errors_to_console_enabled;
   bool hide_scrollbars;
+  bool enable_pinch_zoom;
   // If false, ignore ::-webkit-scrollbar-* CSS pseudo-elements in stylesheets.
   bool enable_webkit_scrollbar_styling = true;
   bool accelerated_2d_canvas_enabled;
